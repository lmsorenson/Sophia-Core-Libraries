#include <tic_tac_toe/models/move.h>

#include <utility>
#include <monte_carlo/factories/tree_factory_interface.h>
#include <format> // Added for std::format
#include <tic_tac_toe/enums/symbol.h> // Added for TileStateToString

using sophia::monte_carlo::tic_tac_toe::models::Move;
using sophia::monte_carlo::tic_tac_toe::enums::TileStateToString;
using sophia::monte_carlo::tic_tac_toe::models::GameState;
using sophia::monte_carlo::tic_tac_toe::models::Position;
using sophia::monte_carlo::models::Action;
using sophia::monte_carlo::models::Node;
using sophia::monte_carlo::factories::TreeFactoryBase;
using std::shared_ptr;

Move::Move(
    const node_base_ptr<GameState, Position> &source,
    const Position change,
    const_factory_ptr<GameState, Position> factory,
    const logger_ptr& logger)
: ActionBase(source, change, std::move(factory), logger)
{

}

std::string Move::Name() const
{
    return m_change_.Name();
}

void Move::Generate()
{
    if (const auto source = m_source_.lock())
    {
        const auto game_state = source->GetState();

        const auto new_state = game_state.ApplyMove(m_change_);

        std::string node_name = std::format("{}{}_T{}", TileStateToString(m_change_.State()), m_change_.Name(), new_state->GetTurnNumber());

        m_target_ = m_factory_->CreateNode(node_name, *new_state);
    }
}

